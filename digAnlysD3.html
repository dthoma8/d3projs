<!DOCTYPE html>
<head>
</head>

<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.9.1/d3.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <div class="datawindow">
    <div class="bokeh_container"><</div>
  </div>
  <script>
    function preFormatContainer() {
      
      var margin={top:20, right:20, bottom:20, left:20},
        width=800-margin.left-margin.right,
        height=600-margin.top-margin.bottom,
        svg = d3.select(".bokeh_container")
          .append("svg")
          .attr("id", "chart")
          .attr("width", 800)
          .attr("height", 800);

      return svg
    }

    function getMeta(data_in) {

      var data = data_in,
        obj={},
        keys=d3.keys(data[0]),
        key_info={};

      // meta info for plot purpose
      key_info["keys"]=[];
      key_info["values"]=[];

      // form arrays for each key
      data.forEach(function(d) {
        keys.forEach(function(k) {
          if (d3.keys(obj).includes(k)) {
            obj[k].push(d[k])
          } else {
            obj[k] = []
            obj[k].push(d[k])
          }
        })
      })

      // check each array for num-coercible values
      keys.forEach(function(k) {

        if (!(k in key_info)) {
          key_info[k]=[];
        }

        if(!obj[k].some(isNaN)) {
          key_info[k]["col_type"] = [];
          key_info[k]["col_type"].push("value");
          key_info["values"].push(k);
          //just take last val for now
          
        } else{
          // instantiate keys
          key_info[k]["col_type"] = [];

          // fill values
          key_info[k]["col_type"].push("filter");
          // need to add cap to select
          key_info["keys"].push(k);
        }
      })
      console.log(key_info);
      return key_info  
      }
    
    function formatBar(data_in, url=false){
      try{
        var data = d3.csvParse(data_in),
          obj=[];
        data.forEach((d)=>(obj.push(d)))

        console.log("This is what obj looks like: ", obj);
        return obj;

      } catch(e){
        return("Failure. %s"%e);
      }
    }

    function processData(data_in, plot_type="") {
      
      var dfd = new $.Deferred();
    
      try {
        if (plot_type == "scatter"){
          var data = formatScatter(data_in);
        } else if (plot_type == 'bar'){
          var data = formatBar(data_in);
           console.log("data within the if clause",data)
        } else if (plot_type == 'line'){
          var data = formatLine(data_in);
        }
        
        console.log("data prior to entering getMeta:", data);
        metaData = getMeta(data);
        data.forEach(function(d) {
          d["meta"]={};
          d["meta"]=metaData;
        })
        console.log(data);
        return data
    
      } catch(e) {
    
        console.log("error in processData! "+e+"\n")
    
      }
      
    }
    
    function readDataFromURL(path, vis_func){
      
      try{
        var hope=[];
        d3.csv(path, function(err, data){
          console.log(data);
          vis_func(data);
        });

        return hope
        
      } catch(e){
        return e
      }
    }

    function createLinearX(data, width){
      var x = d3.scaleLinear().domain([0, 1.05*d3.max(data, (d) => (+d.value))]).range([0, width]).nice(),
        xAxis = d3.axisBottom(x);

      return [x, xAxis]
    }

    function createOrdinalX(data, width){
      console.log("thisiswhatyouareworkingwith",data.map((d)=>(+d.key)))
      
      var x = d3.scaleBand().domain(data.map((d)=>(+d.key))).rangeRound([0, width]),//.nice(),
        xAxis=d3.axisBottom(x);

      return [x, xAxis]
    }

    function createLinearY(data, height){
      
      var y = d3.scaleLinear().domain([0, 1.05*d3.max(data, (d)=>(+d.value))]).range([height, 0]).nice(),
        yAxis = d3.axisLeft(y);

      return [y, yAxis]
    }

    function createOrdinalY(data, height){

      var y = d3.scaleBand().domain(data.map((d)=>(+d.key))).rangeRound([height, 0]),//.nice(),
        yAxis = d3.axisLeft(y);

      return [y, yAxis]
    }

    function xSelect(data, key_info, width){
      //functionality for user changes in x axes
  
      try {
        var value = d3.select(".xselect").value;

        if (key_info[value]["col_type"] == "filter"){
          var X = createOrdinalX(data, width),
            x = X[0],
            xAxis = X[1];
        } else{
          X=createLinearX(data, width);
          var x = X[0],
            xAxis=X[1];
        }
        // proceed w. transformaciones - protect against yourself. comment your code. psa.
        xAxis.scale(x);
        d3.select(".xax").transition().call(xAxis);
        d3.select(".vis_el").transition().duration(1000).delay((i)=>(i*100)).attr("cx", (d)=>(x(+d[value])));

      } catch(e) {
        console.log("Error in xSelect: "+e);
        return(e)
      }
}

    function ySelect(data, key_info, height){
      try{
        var value = d3.select(".yselect").value;
        // need logic on ordinal/value
        if (key_info[value].col_type == 'filter') {
            var Y=createOrdinalY(data, height),
              y=Y[0],
              y=Y[1];
        } else {
          var Y=createLinearY(data, height),
            y=Y[0],
            y=[1];
        }
        yAxis.scale(y);
        d3.select(".yax").transition().call(yAxis);
        d3.select(".vis_el").transition().duration(1000).delay((i)=>(i*100)).attr("cy", (d)=>(y(+d.value)));
      } catch(e) {
        console.log("Error in ySelect: "+e);
        return(e)
      }
    }

    function selectOpts(data){
      var opts = d3.keys(data[0]);
      var xin = d3.select(".bokeh_container").append("select")
          .classed("xselect", true)
          .style("float", "right")
          .style("top", "0px")
          .style("position", "relative")
          //gottathinkbouthis
          // you can always add this after like so: d3.select('mylovelyselect').on('change', func(){})
        .selectAll("option")
          .data(opts)
          .enter()
        .append("option")
          .text((d)=>(d))
          .attr("value",(d)=>(d));

      //d3.select(".bokeh_container").append("br");

      var yin = d3.select(".bokeh_container").append("select")
          .classed("yselect", true)  
          .style("right","8px")
          .style("top", "40px")
          .style("position", "absolute")
        .selectAll("option")
          .data(opts)
          .enter()
        .append("option")
          .text((d)=>(d))    
          .attr("value",(d)=>(d));

      //d3.select(".bokeh_container").append("br");

      return [xin, yin]
    }

    function setTempData(data, key, value){
      data.forEach(function(d){
        // key, value contain the string names of the the cols to be the key and valuue
        // we will fill in a key and value column for each
        
        d["key"]=d[key];
        d["value"]=d[value];
      })
    }
    
    function colorCat(){
      var scale = d3.scaleOrdinal(d3.schemeCategory20);
      return scale
    }
    
    function addLegend(svg, color){
      //heregoesnothing
      // add legend
      var legendrectsize=18,
        legendspacing=7;  
      console.log("This is what color.domain() does",color.domain())
      var legend = svg.selectAll(".legend")
        .data(color.domain())
        .enter()
        .append("g")
        .classed("legend", true)
        .attr("transform", function(d, i){
          var x = 700,
            y = 65+15*i;
          return "translate("+x+","+y+")";
        })

      legend.append("circle")
          .attr("r", 7.5)
          .style("fill", color)
          .attr("fill-opacity", 0.6)
        
      legend.append("text")
        .attr("x", legendrectsize+legendspacing)
        .attr("y", legendrectsize-legendspacing)
        .text(function(d){
          return d;
        })

      return legend
    }
    
    function selectColorCat(d){

    }

    function mouseZoom(X, Y) {
      function zoom() {
        var transform = d3.event.transform,
          new_x = transform.rescaleX(X[0]),
          xAxis = X[1].scale(new_x),
          new_y = transform.rescaleY(Y[0]),
          yAxis = Y[1].scale(new_y);

        d3.select(".xax").call(xAxis);
        d3.select(".yax").call(yAxis);
        d3.selectAll(".vis_el").attr("transform", transform)
      }

      var zoom =  d3.zoom().scaleExtent([0,500]).on("zoom", zoom)//
      return zoom
      }

    function plotBar(data_in) {

      try {
        var data = processData(data_in, "bar"),
          svg = preFormatContainer(),
          main_margin = {top: 20,bottom: 20,left: 20,right: 20},
          main_width = 800 - main_margin.left - main_margin.right,
          main_height = 600 - main_margin.top - main_margin.bottom,
          key = data[0].meta.keys[0],
          value = data[0].meta.values[0];

        console.log("this is the key ",key);
        console.log("this is the value", value)
        setTempData(data, key, value);

        var X = createOrdinalX(data, main_width),
          Y = createLinearY(data, main_height),
          x=X[0],
          xAxis=X[1],
          y=Y[0],
          yAxis=Y[1],
          zoom = mouseZoom(X, Y);

        function plot(params){

          // scale data values to axes
          var ymain = d3
                        .scaleLinear()
                        .domain([0, d3.max(data, (d) => (+d.value))])
                        .range([main_height, 0]),

              xmain = d3
                        .scaleBand()
                        .domain(data.map((d) => (+d.key)))
                        .rangeRound([0, main_width]);
          
          this.append("g")
            //.call(zoom)
            .classed("chart", true)  
            .attr("transform", "translate(" + main_margin.left + "," + main_margin.top + ")")
          .selectAll(".bar")
            .data(params.data, function(d){
              return d;
            })
            .enter()
            .append("rect")
              .classed("vis_el", true)
              .attr("class", function(d,i) {return "bar\t" + d.key + "\t" + d.value})
              .attr("y", 0)
              .attr("x", function(d,i){
                return x(d.key);
              })
              .attr("height", function(d,i){
                return x.bandwidth()-1;
              })
              .attr("width", function(d){
                return y(d.value);    
              })
              .attr("fill", "steelblue")
              .attr("fill-opacity", "0.6")
              .on("mouseover", function() {
                d3.select(this).attr("fill", "orange").append("title").text(function(d) {return d.key+" : "+d.value;})
              })
              .on("mouseout", function() {
                d3.select(this).attr("fill", "steelblue");
              });
          this.append('g')
            .attr("class", "xax")
            .attr("transform", "translate(0,"+main_height+")")
            .call(xAxis)
            .selectAll("text")
              .style("text-anchor", "end")
              .attr('dx', "-.8em")
              .attr("dy", ".55em")
              .attr("transform", "rotate(-60)");
          this.append("g")
            .attr("class", "yax")
            .call(yAxis);
        }

        plot.call(svg, {data: data});
      } catch(e) {
        console.log("plotBar failed!" + e)
      }
    }
    
    //var hope = readDataFromURL(path="https://raw.githubusercontent.com/dthoma8/d3projs/master/data/av_data.csv")

    var data_in = 'TMS,TAI\nA-10A,325.0998\nA-10C,1010.16\nAC-130H,40.0\nAC-130U,67.953\nAC-130W,13.0\nAT-38B,12.0\nB-1B,261.881\nB-2A,20.42\nB-52H,92.92\nC-12C,48.0\nC-12D,12.0\nC-12F,9.0\nC-12J,16.0\nC-130E,174.7017\nC-130H,539.1569999999999\nC-130J,118.92\nC-17A,400.91999999999996\nC-20B,10.0\nC-20C,6.0\nC-20E,1.0\nC-20H,4.0\nC-20K,2.0\nC-21A,104.83\nC-27J,11.42\nC-32A,12.0\nC-32B,8.0\nC-37A,16.0\nC-37B,5.08\nC-38A,4.0\nC-40B,8.0\nC-40C,17.92\nC-5A,177.0\nC-5B,82.7295\nC-5C,4.0\nC-5M,6.84\nCV-22B,8.25\nE-11A,0.08\nE-3B,114.42\nE-3C,44.42\nE-3G,1.17\nE-4B,12.0\nE-8C,34.0\nEC-130H,42.0\nEC-130J,28.0\nF-15A,73.10824\nF-15B,5.83\nF-15C,834.174\nF-15D,104.0\nF-15E,889.3399999999999\nF-16A,0.42\nF-16B,2.98634\nF-16C,2847.8419999999996\nF-16D,337.0\nF-22A,262.33000000000004\nHC-130J,4.17\nHC-130N,30.0\nHC-130P,46.0\nHH-60G,200.75\nKC-10A,118.0\nKC-135E,64.4492\nKC-135R,1088.17\nKC-135T,108.0\nLC-130H,20.0\nMC-12W,78.0\nMC-130E,32.65981\nMC-130H,80.0\nMC-130J,7.08\nMC-130P,78.0\nMC-130W,25.3163\nMH-53M,13.931\nMQ-1B,175.08\nMQ-9A,85.0\nNC-130H,1.0\nNC-135W,5.0\nNKC-135E,0.92\nOA-10A,78.3741\nOC-135B,6.0\nRC-135S,3.0\nRC-135U,8.0\nRC-135V,32.0\nRC-135W,27.0\nRC-26B,22.0\nRQ-4A,18.93151\nRQ-4B,39.09\nT-1A,713.92\nT-37B,131.0648\nT-38A,134.82999999999998\nT-38C,1349.492\nT-41D,16.0\nT-43A,8.0\nT-51A,9.0\nT-53A,16.42\nT-6A,1170.5\nTC-130H,3.0\nTC-135S,3.92\nTC-135W,9.08\nTE-8A,4.0\nTG-10A,3.0\nTG-10B,23.0\nTG-10C,9.17\nTG-10D,8.0\nTG-12A,3.17\nTG-14A,14.0\nTG-15A,4.0\nTG-15B,3.0\nTG-16A,11.83\nTH-1H,59.25\nTU-2S,15.0\nU-2S,84.0\nUH-1H,49.3504\nUH-1N,61.5\nUH-1V,5.0\nUV-18B,9.0\nVC-25A,6.0\nWC-130H,28.75\nWC-130J,30.0\nWC-135C,1.0';
    plotBar(data_in);
    

  </script>
</body>

