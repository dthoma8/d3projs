<!DOCTYPE html>
<head>
</head>

<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.9.1/d3.min.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
  <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
  <div class="datawindow">
    <div class="bokeh_container"><</div>
  </div>
  <script>
    function preFormatContainer() {
      
      var margin={top:20, right:20, bottom:20, left:20},
        width=800-margin.left-margin.right,
        height=600-margin.top-margin.bottom,
        svg = d3.select(".bokeh_container")
          .append("svg")
          .attr("id", "chart")
          .attr("width", 800)
          .attr("height", 800);

      return svg
    }

    function formatScatter(data_in) {

      var data = d3.csvParse(data_in),
        obj = [],
        keys = d3.keys(data[0]);
      
      if (keys.includes("x") & keys.includes("y")) {
        data.forEach((d) => (obj.push(d)))
        return obj;
      } else {
        return("X,y keys not provided in scatter data.")
      }
    }

    function getMeta(data_in) {

      var data = data_in,
        obj={},
        keys=d3.keys(data[0]),
        key_info={};
      
      // meta info for plot purpose
      key_info["color_by"]=[];
      key_info["size_by"]=[];

      // form arrays for each key
      data.forEach(function(d) {
        keys.forEach(function(k) {
          if (d3.keys(obj).includes(k)) {
            obj[k].push(d[k])
          } else {
            obj[k] = []
            obj[k].push(d[k])
          }
        })
      })

      // check each array for num-coercible values
      keys.forEach(function(k) {

        if (!(k in key_info)) {
          key_info[k]=[];
        }

        if(!obj[k].some(isNaN)) {
          key_info[k]["col_type"] = [];
          key_info[k]["col_type"].push("value");
          //just take last val for now
          
        } else{
          // instantiate keys
          key_info[k]["col_type"] = [];

          // fill values
          key_info[k]["col_type"].push("filter");
          // need to add cap to select
          key_info["color_by"]=[k]
        }
      })
      console.log(key_info);
      return key_info  
    }

    function processData(data_in) {
      
      var dfd = new $.Deferred();

      try {

        var data = formatScatter(data_in),
          metaData = getMeta(data);

        data.forEach(function(d) {
          d["meta"]={};
          d["meta"]=metaData;
        })

        console.log(data);
        return data

      } catch(e) {

        console.log("error in processData! "+e+"\n")

      }
      
    }

    function readDataFromURL(path, vis_func){
      
      try{
        var hope=[];
        d3.csv(path, function(err, data){
          console.log(data);
          vis_func(data);
        });

        return hope
        
      } catch(e){
        return e
      }
    }

    function createLinearX(data, width){
      var x = d3.scaleLinear().domain([0, 1.05*d3.max(data, (d) => (+d.x))]).range([0, width]).nice(),
        xAxis = d3.axisBottom(x);

      return [x, xAxis]
    }

    function createOrdinalX(data, width){
      var x = d3.scaleBand().domain(data.map((d)=>(+d.key))).rangeRound([0, width]).nice(),
        xAxis=d3.axisBottom(x);

      return [x, xAxis]
    }

    function createLinearY(data, height){
      var y = d3.scaleLinear().domain([0, 1.05*d3.max(data, (d)=>(+d.y))]).range([height, 0]).nice(),
        yAxis = d3.axisLeft(y);

      return [y, yAxis]
    }

    function createOrdinalY(data, height){
      var y = d3.scaleBand().domain(data.map((d)=>(+d.key))).rangeRound([height, 0]).nice(),
        yAxis = d3.axisLeft(y);

      return [y, yAxis]
    }

    function xSelect(data, key_info, width){
      //functionality for user changes in x axes
  
      try {
        var value = d3.select(".xselect").value;

        if (key_info[value]["col_type"] == "filter"){
          var X = createOrdinalX(data, width),
            x = X[0],
            xAxis = X[1];
        } else{
          X=createLinearX(data, width);
          var x = X[0],
            xAxis=X[1];
        }
        // proceed w. transformaciones - protect against yourself. comment your code. psa.
        xAxis.scale(x);
        d3.select(".xax").transition().call(xAxis);
        d3.select(".vis_el").transition().duration(1000).delay((i)=>(i*100)).attr("cx", (d)=>(x(+d[value])));

      } catch(e) {
        console.log("Error in xSelect: "+e);
        return(e)
      }
}

    function ySelect(data, key_info, height){
      try{
        var value = d3.select(".yselect").value;
        // need logic on ordinal/value
        if (key_info[value].col_type == 'filter') {
            var Y=createOrdinalY(data, height),
              y=Y[0],
              y=Y[1];
        } else {
          var Y=createLinearY(data, height),
            y=Y[0],
            y=[1];
        }
        yAxis.scale(y);
        d3.select(".yax").transition().call(yAxis);
        d3.select(".vis_el").transition().duration(1000).delay((i)=>(i*100)).attr("cy", (d)=>(y(+d[value])));
      } catch(e) {
        console.log("Error in ySelect: "+e);
        return(e)
      }
    }

    function selectOpts(data){
      var opts = d3.keys(data[0]);
      var xin = d3.select(".bokeh_container").append("select")
          .classed("xselect", true)
          .style("float", "right")
          .style("top", "0px")
          .style("position", "relative")
          //gottathinkbouthis
          // you can always add this after like so: d3.select('mylovelyselect').on('change', func(){})
        .selectAll("option")
          .data(opts)
          .enter()
        .append("option")
          .text((d)=>(d))
          .attr("value",(d)=>(d));

      //d3.select(".bokeh_container").append("br");

      var yin = d3.select(".bokeh_container").append("select")
          .classed("yselect", true)  
          .style("right","8px")
          .style("top", "40px")
          .style("position", "absolute")
        .selectAll("option")
          .data(opts)
          .enter()
        .append("option")
          .text((d)=>(d))    
          .attr("value",(d)=>(d));

      //d3.select(".bokeh_container").append("br");

      return [xin, yin]
    }

    function colorCat(){
      var scale = d3.scaleOrdinal(d3.schemeCategory20);
      return scale
    }
    
    function addLegend(svg, color){
      //heregoesnothing
      // add legend
      var legendrectsize=18,
        legendspacing=7;  
      console.log("This is what color.domain() does",color.domain())
      var legend = svg.selectAll(".legend")
        .data(color.domain())
        .enter()
        .append("g")
        .classed("legend", true)
        .attr("transform", function(d, i){
          var x = 700,
            y = 65+15*i;
          return "translate("+x+","+y+")";
        })

      legend.append("circle")
          .attr("r", 7.5)
          .style("fill", color)
          .attr("fill-opacity", 0.6)
        
      legend.append("text")
        .attr("x", legendrectsize+legendspacing)
        .attr("y", legendrectsize-legendspacing)
        .text(function(d){
          return d;
        })

      return legend
    }
    
    function selectColorCat(d){

    }

    function mouseZoom(X, Y) {
      function zoom() {
        var transform = d3.event.transform,
          new_x = transform.rescaleX(X[0]),
          xAxis = X[1].scale(new_x),
          new_y = transform.rescaleY(Y[0]),
          yAxis = Y[1].scale(new_y);

        d3.select(".xax").call(xAxis);
        d3.select(".yax").call(yAxis);
        d3.selectAll(".vis_el").attr("transform", transform)
      }

      var zoom =  d3.zoom().scaleExtent([0,500]).on("zoom", zoom)//
      return zoom
      }

    function plotBar(data_in) {

      try {
        var data = processData(data_in, "plotBar"),
          key_info=getMeta(data),
          svg = preFormatContainer(), 
          main_margin = {top: 20,bottom: 20,left: 20,right: 20},
          mini_margin = {top: 20, bottom: 20, left: 20, right: 5},
          main_width = 800 - main_margin.left - main_margin.right,
          main_height = 600 - main_margin.top - main_margin.bottom,
          mini_width = 100-mini_margin.left-mini_margin.right,
          mini_height=800-mini_margin.top-mini_margin.bottom,
          X = createLinearX(data,main_width),
          Y = createOrdinalY(data, main_height),
          x=X[0],
          xAxis=X[1],
          y=Y[0],
          yAxis=Y[1],
          zoom = mouseZoom(X, Y);

        function plot(params){

          // scale data values to axes
          var ymain = d3.scaleLinear().domain([0, d3.max(data, (d) => (+d.value))]).range([main_height, 0]),
            xmain = d3.scaleBand().domain(data.map((d) => (d.key))).rangeRound([0, main_width]),
            ymini = d3.scaleLinear().domain([0, d3.max(data, (d) => (+d.value))]).range([mini_height, 0]),
            xmini = d3.scaleBand().domain(data.map((d) => (d.key))).rangeRound([0, mini_width]);
          
          this.append("g")
            //.call(zoom)
            .classed("chart", true)  
            .attr("transform", "translate(" + main_margin.left + "," + main_margin.top + ")")
          .selectAll(".bar")
            .data(params.data)
            .enter()
            .append("rect")
              .classed("vis_el", true)
              .attr("class", function(d,i) {return "bar\t" + d.key + "\t" + d.value})
              .attr("x", 0)
              .attr("y", function(d,i){
                return y(d.key);
              })
              .attr("height", function(d,i){
                return y.bandwidth()-1;
              })
              .attr("width", function(d){
                return x(d.value);    
              })
              .attr("fill", "steelblue")
              .attr("fill-opacity", "0.6")
              .on("mouseover", function() {
                d3.select(this).attr("fill", "orange").append("title").text(function(d) {return d.key+" : "+d.value;})
              })
              .on("mouseout", function() {
                d3.select(this).attr("fill", "steelblue");
              });
          this.append('g')
            .attr("class", "xax")
            .attr("transform", "translate(0,"+main_height+")")
            .call(xAxis)
            .selectAll("text")
              .style("text-anchor", "end")
              .attr('dx', "-.8em")
              .attr("dy", ".55em")
              .attr("transform", "rotate(-60)");
          this.append("g")
            .attr("class", "yax")
            .call(yAxis);
        }

        plot.call(svg, {data: data});
      } catch(e) {
        console.log("plotBar failed!" + e)
      }
    }
    
    var hope = readDataFromURL(path="https://raw.githubusercontent.com/dthoma8/d3projs/master/data/av_data.csv")
    console.log("you just gotta believe and have some: ", hope)
    

  </script>
</body>

